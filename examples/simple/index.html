
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="/assets/marina_logo.svg">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-8.5.10">
    
    
      
        <title>Simple FastAPI Example - Saleor SDK Python</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="deep-purple">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#simple-fastapi-example" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Saleor SDK Python" class="md-header__button md-logo" aria-label="Saleor SDK Python" data-md-component="logo">
      
  <img src="/assets/marina_logo_white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Saleor SDK Python
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Simple FastAPI Example
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="deep-purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="light-blue" data-md-color-accent="deep-purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/mirumee/saleor-sdk-python" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Saleor SDK Python" class="md-nav__button md-logo" aria-label="Saleor SDK Python" data-md-component="logo">
      
  <img src="/assets/marina_logo_white.svg" alt="logo">

    </a>
    Saleor SDK Python
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mirumee/saleor-sdk-python" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Examples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Examples" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Simple FastAPI Example
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Simple FastAPI Example
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#declare-the-app-manifest" class="md-nav__link">
    Declare the App manifest
  </a>
  
    <nav class="md-nav" aria-label="Declare the App manifest">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#more-on-subscription-queries" class="md-nav__link">
    More on Subscription queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-some-commonly-used-dependencies" class="md-nav__link">
    Define some commonly used dependencies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jwks-and-user-jwt-verification" class="md-nav__link">
    JWKS and user JWT verification
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#webhook-signature-verification" class="md-nav__link">
    Webhook signature verification
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#finally-define-the-app-endpoints" class="md-nav__link">
    Finally define the app endpoints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-the-complete-example" class="md-nav__link">
    Running the complete example
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../tools/" class="md-nav__link">
        External tools
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#declare-the-app-manifest" class="md-nav__link">
    Declare the App manifest
  </a>
  
    <nav class="md-nav" aria-label="Declare the App manifest">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#more-on-subscription-queries" class="md-nav__link">
    More on Subscription queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-some-commonly-used-dependencies" class="md-nav__link">
    Define some commonly used dependencies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jwks-and-user-jwt-verification" class="md-nav__link">
    JWKS and user JWT verification
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#webhook-signature-verification" class="md-nav__link">
    Webhook signature verification
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#finally-define-the-app-endpoints" class="md-nav__link">
    Finally define the app endpoints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-the-complete-example" class="md-nav__link">
    Running the complete example
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/mirumee/saleor-sdk-python/edit/main/docs/examples/simple.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="simple-fastapi-example">Simple FastAPI Example<a class="headerlink" href="#simple-fastapi-example" title="Permanent link">&para;</a></h1>
<p>The following is a single module FastAPI app written as a demo of the Saleor SDK Python package.
This <strong>should not</strong> be treated as a production ready application.</p>
<p>For the sake of time let's import everything that will be needed upfront, initialize the app and put a JWKS storage in place:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">Header</span>
<span class="kn">from</span> <span class="nn">pydantic_settings</span> <span class="kn">import</span> <span class="n">BaseSettings</span>
<span class="kn">import</span> <span class="nn">httpx</span>
<span class="kn">from</span> <span class="nn">jwt.api_jwk</span> <span class="kn">import</span> <span class="n">PyJWKSet</span>

<span class="kn">from</span> <span class="nn">saleor_sdk.schemas.manifest</span> <span class="kn">import</span> <span class="n">Manifest</span><span class="p">,</span> <span class="n">Webhook</span>
<span class="kn">from</span> <span class="nn">saleor_sdk.schemas.enums</span> <span class="kn">import</span> <span class="n">Permission</span><span class="p">,</span> <span class="n">WebhookAsyncEvents</span>
<span class="kn">from</span> <span class="nn">saleor_sdk.crypto.utils</span> <span class="kn">import</span> <span class="n">decode_webook_payload</span><span class="p">,</span> <span class="n">decode_jwt</span>
<span class="kn">from</span> <span class="nn">saleor_sdk.crypto.exceptions</span> <span class="kn">import</span> <span class="n">JWKSKeyMissing</span>


<span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
<span class="n">saleor_jwks</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
<h2 id="declare-the-app-manifest">Declare the App manifest<a class="headerlink" href="#declare-the-app-manifest" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/manifest&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">manifest</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Manifest</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;simple-sdk-test-app&quot;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="s2">&quot;0.0.0&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Simple SDK Test APP&quot;</span><span class="p">,</span>
<span class="hll">        <span class="n">permissions</span><span class="o">=</span><span class="p">[</span><span class="n">Permission</span><span class="o">.</span><span class="n">MANAGE_ORDERS</span><span class="p">,</span> <span class="s2">&quot;MANAGE_CHECKOUTS&quot;</span><span class="p">],</span>
</span><span class="hll">        <span class="n">app_url</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;app_config&quot;</span><span class="p">)),</span>
</span>        <span class="n">token_target_url</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;register&quot;</span><span class="p">)),</span>
        <span class="n">webhooks</span><span class="o">=</span><span class="p">[</span>
            <span class="n">Webhook</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Order Handler&quot;</span><span class="p">,</span>
<span class="hll">                <span class="n">async_events</span><span class="o">=</span><span class="p">[</span><span class="n">WebhookAsyncEvents</span><span class="o">.</span><span class="n">ORDER_CREATED</span><span class="p">,</span> <span class="s2">&quot;ORDER_UPDATED&quot;</span><span class="p">],</span>
</span><span class="hll">                <span class="n">query</span><span class="o">=</span><span class="s2">&quot;subscription { event { issuedAt issuingPrincipal { ... on App { id } ... on User { id } } ... on OrderCreated { order { id }} ... on OrderUpdated { order { id }}}}&quot;</span><span class="p">,</span>
</span>                <span class="n">target_url</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;order_handler&quot;</span><span class="p">)),</span>
                <span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">],</span>
    <span class="p">)</span>
</code></pre></div>
<p>There are a few things to notice here:</p>
<ul>
<li><strong>enums</strong> - the SDK will try to keep the definitions up-to-date with Saleor but there is no promise this will always meet your needs (time-wise), this is why you can use both, the definitions from <code>saleor_sdk.schemas.enums</code> and plain strings.</li>
<li><strong><code>request.url_for()</code></strong> - Saleor needs a full URL to your endpoint, here we leverage FastAPI's resolver (be mindful about what your proxy is doing, i.e. it's easy to hide crucial information from FastAPI with Gunicorn)</li>
<li><strong>Subscription queries</strong> - the payload that webhook is to carry.</li>
</ul>
<h3 id="more-on-subscription-queries">More on Subscription queries<a class="headerlink" href="#more-on-subscription-queries" title="Permanent link">&para;</a></h3>
<p>Since Saleor 3.2 (and 3.6 for synchronous events) one can define the payload that Saleor will send to an app - this allows you to define a payload that is meaningful to the app. </p>
<p><a href="https://docs.saleor.io/docs/3.x/developer/extending/apps/subscription-webhook-payloads">Saleor docs: Subscription Webhook Payloads</a></p>
<p>A formatted query from the example looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">subscription</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">event</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">issuedAt</span>
<span class="w">    </span><span class="n">issuingPrincipal</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="nc">App</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">id</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="p">...</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="nc">User</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">id</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="nc">OrderCreated</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">order</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">id</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="nc">OrderUpdated</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">order</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">id</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>and will result in the following payload being sent to the app:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;issuedAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2022-12-12T00:37:17.405467+00:00&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;issuingPrincipal&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;VXNlcjoyMDU5ODA1MTg0&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;order&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;T3JkZXI6MWFkNzZjOTctZDkxNy00NjRmLWIwNzUtOTljNzcwY2IzOWI4&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="define-some-commonly-used-dependencies">Define some commonly used dependencies<a class="headerlink" href="#define-some-commonly-used-dependencies" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_saleor_event</span><span class="p">(</span><span class="n">saleor_event</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;Saleor-Event&quot;</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">saleor_event</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">get_saleor_domain</span><span class="p">(</span><span class="n">saleor_domain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;Saleor-Domain&quot;</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">saleor_domain</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">get_saleor_signature</span><span class="p">(</span>
    <span class="n">saleor_signature</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;Saleor-Signature&quot;</span><span class="p">)</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="n">saleor_signature</span>
</code></pre></div>
<h2 id="jwks-and-user-jwt-verification">JWKS and user JWT verification<a class="headerlink" href="#jwks-and-user-jwt-verification" title="Permanent link">&para;</a></h2>
<p>There are currently two ways to verify the authenticity of a Saleor issued JWT:
- online - by calling Saleor to check (deprecated by Saleor)
- offline - by checking with Saleor's public keyset.
This library only supports the offline method.</p>
<p>Saleor instances expose a <code>/.well-known/jwks.json</code> endpoint which exposes the public part of the RSA key used to sign the JWTs.
With that we can verify if the incoming token is indeed coming straight from Saleor and if we can trust it's claims.</p>
<p>To do that we need a storage within the app's memory to hold on to the JWKS (JSON Web Key Set), in this example we are simply using a global variable.</p>
<p>The <code>get_saleor_user</code> dependency ensures the JWKS was initialized (first request in the runtime), then validates the token. If the local JWKS is missing a key, a <code>JWKSKeyMissing</code> error will be raised and an attempt to get a fresh one from Saleor will be made - this might happen when Saleor rotates the keys and starts signing JWTs with the new key.</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_jwks</span><span class="p">(</span><span class="n">saleor_domain</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">saleor_domain</span><span class="si">}</span><span class="s2">/.well-known/jwks.json&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">get_saleor_user</span><span class="p">(</span>
    <span class="n">saleor_domain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_saleor_domain</span><span class="p">),</span>
    <span class="n">saleor_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;Saleor-Token&quot;</span><span class="p">),</span>
<span class="p">):</span>
    <span class="k">global</span> <span class="n">saleor_jwks</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">saleor_jwks</span><span class="p">:</span>
        <span class="n">saleor_jwks</span> <span class="o">=</span> <span class="n">PyJWKSet</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="k">await</span> <span class="n">fetch_jwks</span><span class="p">(</span><span class="n">saleor_domain</span><span class="p">))</span>

    <span class="n">max_attempts</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">max_attempts</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">decode_jwt</span><span class="p">(</span>
                <span class="n">jwt</span><span class="o">=</span><span class="n">saleor_token</span><span class="p">,</span>
                <span class="n">jwks</span><span class="o">=</span><span class="n">saleor_jwks</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">JWKSKeyMissing</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_attempts</span><span class="p">:</span>
                <span class="n">saleor_jwks</span> <span class="o">=</span> <span class="n">PyJWKSet</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="k">await</span> <span class="n">fetch_jwks</span><span class="p">(</span><span class="n">saleor_domain</span><span class="p">))</span>
                <span class="n">max_attempts</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
</code></pre></div>
<p>Here's how it roughly works in sequence</p>
<pre class="mermaid"><code>sequenceDiagram
    actor USR as User
    participant SAL as Saleor
    participant APP as App
    participant STO as JWKS Storage

    USR -&gt;&gt; SAL: Here are my credentials, give me a JWT
    SAL -&gt;&gt; USR: Here's your JWT

    USR -&gt;&gt; APP: Give me that secret resource
    APP -&gt;&gt; STO: I've got a JWT with kid=1 do you have something on that?
    alt Storage does not have the kid=1
        STO -&gt;&gt; APP: No I don't
        APP -&gt;&gt; SAL: Fetch JWKS
        SAL -&gt;&gt; APP: JWKS
        APP -&gt;&gt; STO: Save JWKS
    else
        STO -&gt;&gt; APP: Yes, here is the public key
    end
    APP -&gt;&gt; APP: Verify the JWT signature
    APP -&gt;&gt; USR: Here's the data</code></pre>
<h2 id="webhook-signature-verification">Webhook signature verification<a class="headerlink" href="#webhook-signature-verification" title="Permanent link">&para;</a></h2>
<p>A very similar process applies to webhook authenticity verification. Leveraging the public key pair issued by Saleor the signature of a JWS (a JWT with detached payload) that is sent with a webhook can be verified in an offline manner.</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">verify_webhook_signature</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">saleor_domain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_saleor_domain</span><span class="p">),</span>
    <span class="n">jws</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_saleor_signature</span><span class="p">),</span>
<span class="p">):</span>
    <span class="k">global</span> <span class="n">saleor_jwks</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">saleor_jwks</span><span class="p">:</span>
        <span class="n">saleor_jwks</span> <span class="o">=</span> <span class="n">PyJWKSet</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="k">await</span> <span class="n">fetch_jwks</span><span class="p">(</span><span class="n">saleor_domain</span><span class="p">))</span>

    <span class="n">max_attempts</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">max_attempts</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">decode_webook_payload</span><span class="p">(</span>
                <span class="n">jws</span><span class="o">=</span><span class="n">jws</span><span class="p">,</span>
                <span class="n">jwks</span><span class="o">=</span><span class="n">saleor_jwks</span><span class="p">,</span>
                <span class="n">webhook_payload</span><span class="o">=</span><span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">JWKSKeyMissing</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_attempts</span><span class="p">:</span>
                <span class="n">saleor_jwks</span> <span class="o">=</span> <span class="n">PyJWKSet</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="k">await</span> <span class="n">fetch_jwks</span><span class="p">(</span><span class="n">saleor_domain</span><span class="p">))</span>
                <span class="n">max_attempts</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
</code></pre></div>
<h2 id="finally-define-the-app-endpoints">Finally define the app endpoints<a class="headerlink" href="#finally-define-the-app-endpoints" title="Permanent link">&para;</a></h2>
<p>You need the two endpoints required by Saleor's framework:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;app_config&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">app_config</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;OK&quot;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/register&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;register&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;OK&quot;</span>
</code></pre></div>
<ul>
<li><code>app_config</code> - this is the endpoint that is expected to respond with HTML that will initialize a React App in the Saleor Dashboard (read more on <a href="https://github.com/saleor/saleor-app-sdk">@saleor/app-sdk</a>)</li>
<li><code>register</code> - this endpoint receives the app_token which needs to be persisted securely, it's used by the app to authenticate with Saleor</li>
</ul>
<p>Further we define the order webhook handler which leverages our <code>verify_webhook_signature</code> dependency.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/webhook/order&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;order_handler&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">order_handler</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> 
    <span class="n">_verify_webhook_signature</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">verify_webhook_signature</span><span class="p">),</span>
    <span class="n">event_type</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_saleor_event</span><span class="p">),</span>
<span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">event_type</span><span class="p">)</span>  <span class="c1"># Use in case you have one handler for many event types</span>
    <span class="nb">print</span><span class="p">(</span><span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">())</span>
    <span class="k">return</span> <span class="s2">&quot;OK&quot;</span>
</code></pre></div>
<p>And an additional endpoint that could be used by the Dashboard UI to for example change the app configuration</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">user_login</span><span class="p">(</span><span class="n">saleor_user</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_saleor_user</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">saleor_user</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;OK&quot;</span>
</code></pre></div>
<h2 id="running-the-complete-example">Running the complete example<a class="headerlink" href="#running-the-complete-example" title="Permanent link">&para;</a></h2>
<p>Install the <code>examples</code> dependencies with:</p>
<div class="highlight"><pre><span></span><code>hatch -e examples shell
</code></pre></div>
<p>Then navigate to the example and run it with uvicorn:</p>
<div class="highlight"><pre><span></span><code>cd docs/examples/simple
uvicorn app:app --reload
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../.." class="md-footer__link md-footer__link--prev" aria-label="Previous: Introduction" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Introduction
            </div>
          </div>
        </a>
      
      
        
        <a href="../../tools/" class="md-footer__link md-footer__link--next" aria-label="Next: External tools" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              External tools
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 - Mirumee Software
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
  <div class="md-copyright__highlight made-with-love">
    <a href="https://mirumee.com">Saleor SDK Python is crafted with love by <img class="footer_mirumee_logo" src="/assets/mirumee.png" alt="Mirumee"></a>
  </div>
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>